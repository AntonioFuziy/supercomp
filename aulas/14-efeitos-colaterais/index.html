
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="https://insper.github.io/supercomp/aulas/14-efeitos-colaterais/">
      
      
        <meta name="author" content="Igor Montagner, Lucianos Soares">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.0">
    
    
      
        <title>14 - Efeitos colaterais - SuperComputação - 2020/2</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bc7e593a.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab28b872.min.css">
        
          
          
          <meta name="theme-color" content="#757575">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/printing.css">
    
      <link rel="stylesheet" href="../../css/extra.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="grey" data-md-color-accent="red">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#14-efeitos-colaterais" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      











<!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->

<script>
  window.site_url = "https://insper.github.io/supercomp/";
</script>

<div class="md-printing-header">
  <img class="cabecalho" src="https://insper.github.io/supercomp/css/cabecalho.png">
  <img class="logo" src="https://insper.github.io/supercomp/css/logo.png">

  <div class="frontmatter">
    <div class="materia"> SuperComputação </div>
    <div class="professor"> Igor Montagner, Luciano Soares </div>
    <div class="semestre"> 2020/2 </div>
  </div>
</div>

<header class="md-header" data-md-component="header">

  <!-- Top-level navigation -->
  <nav class="md-header-nav md-grid" aria-label="Header">

    <!-- Link to home -->
    <a
      href="https://insper.github.io/supercomp/"
      title="SuperComputação - 2020/2"
      class="md-header-nav__button md-logo"
      aria-label="SuperComputação - 2020/2"
    >
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>

    <!-- Button to open drawer -->
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>

    <!-- Header title -->
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            SuperComputação - 2020/2
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              14 - Efeitos colaterais
            
          </span>
        </div>
      
    </div>

    <!-- Button to open search dialogue -->
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>

      <!-- Search interface -->
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    

    <!-- Repository containing source -->
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/insper/supercomp/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    SuperComp
  </div>
</a>
      </div>
    
  </nav>
</header>




    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://insper.github.io/supercomp/" title="SuperComputação - 2020/2" class="md-nav__button md-logo" aria-label="SuperComputação - 2020/2">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    SuperComputação - 2020/2
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/insper/supercomp/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    SuperComp
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../sobre/" class="md-nav__link">
      Burocracias
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Aulas
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Aulas" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Aulas
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../01-introducao/" class="md-nav__link">
      01 - Aquecimento
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../02-desempenho/" class="md-nav__link">
      02 - Iniciando C++11
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../03-profiling-e-projeto/" class="md-nav__link">
      03 - Profiling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../04-projeto-heuristicas/" class="md-nav__link">
      04 - Heurísticas
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../05-algoritmos-aleatorios/" class="md-nav__link">
      05 - Algoritmos Aleatorizados
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../06-busca-local/" class="md-nav__link">
      06 - Busca local
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../07-busca-exaustiva/" class="md-nav__link">
      07 - Busca exaustiva
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../08-busca-exaustiva-II/" class="md-nav__link">
      08 - Comparação de resultados
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../09-branch-and-bound/" class="md-nav__link">
      09 - Branch and Bound
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../10-branch-and-bound-II/" class="md-nav__link">
      10 - Branch and Bound II
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../11-introducao-paralelismo/" class="md-nav__link">
      11 - Introdução a paralelismo
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../12-introducao-omp/" class="md-nav__link">
      12 - Introdução a OpenMP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../13-paralelismo-dados/" class="md-nav__link">
      13 - Paralelismo de dados
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Projeto
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Projeto" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Projeto
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/" class="md-nav__link">
      Travelling Sales Person (TSP)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/checklist/" class="md-nav__link">
      Checklist de projeto
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/heuristica/" class="md-nav__link">
      Heurística da cidade mais próxima
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/busca-local/" class="md-nav__link">
      Busca local
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/busca-exaustiva/" class="md-nav__link">
      Busca exaustiva
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/desempenho-sequencial/" class="md-nav__link">
      Desempenho sequencial
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#geradores-de-numeros-aleatorios" class="md-nav__link">
    Geradores de números aleatórios
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sincronizacao-com-regioes-criticas" class="md-nav__link">
    Sincronização com regiões críticas
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/insper/supercomp/edit/master/docs/aulas/14-efeitos-colaterais/index.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="14-efeitos-colaterais">14 - Efeitos colaterais<a class="headerlink" href="#14-efeitos-colaterais" title="Permanent link">&para;</a></h1>
<p>Nesta aula iremos aprender a controlar os efeitos colaterais de programas paralelos. Nossa estratégia se baseará na ideia de que o resultado de um programa paralelo deverá se manter igual em toda execução, a não ser que explicitamente seja pedido o contrário. </p>
<h2 id="geradores-de-numeros-aleatorios">Geradores de números aleatórios<a class="headerlink" href="#geradores-de-numeros-aleatorios" title="Permanent link">&para;</a></h2>
<p>Na última aula vimos que nossa implementação de <code>discard</code> era <code>O(N)</code>, o que tornava nosso algoritmo <span><span class="MathJax_Preview">O(N^2)</span><script type="math/tex">O(N^2)</script></span> e invalidava qualquer ganho vindo do paralelismo. Vamos então abdicar de uma implementação literalmente igual à sequencial e tomar como boa uma implementação que, mantendo fixo o número de threads, retorna sempre os mesmos resultados. Ou seja, adicionamos como parâmetro do programa o número de threads a serem usadas. Se mantivermos os mesmos parâmetros (agora incluindo número de threads) os resultados serão mantidos.</p>
<p>Claramente não é o ideal, mas é suficiente se formos explícitos nessa condição. Lembrando que um dos nossos objetivos é ganhar desempenho mantendo a previsibilidade e a reprodutibilidade.</p>
<p>Nossa ideia será então,</p>
<p><strong>criar um gerador de números aleatórios por thread.</strong></p>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Explique por que esta ideia controla os efeitos colaterais. Quais funcionalidades do OpenMP nos ajudariam a fazer isto?</p>
<details class="details"><summary>Resposta</summary><p>Ao criar um gerador para cada thread evitamos o acesso desordenado a um único gerador. Com somente um gerador global precisaríamos forçar uma ordem completa para ter resultados reprodutíveis (já que não controlamos quando cada thread roda). Com um gerador por thread conseguimos garantir que cada thread verá sempre a mesma sequência de números. Faltaria só garantir que cada thread executa sempre as mesmas iterações do loop. Isso pode ser feito usando o agendamento <code>static</code> do <code>for</code> paralelo. </p>
</details>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Implemente a ideia descrita acima. Você pode quebrar nos seguintes passos:</p>
<ol>
<li>criar um gerador para cada thread. Use <code>omp_get_max_threads</code> para saber o máximo de threads criáveis durante a execução.</li>
<li>use uma <code>seed</code> diferente para cada gerador. Você pode usar alguma conta relacionada ao <code>id</code> da thread para isto.</li>
<li>dentro do loop, acesse somente o gerador da thread em execução. Veja como pegar esse <em>id</em> nos exemplos da aula passada</li>
</ol>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Execute diversas vezes o programa acima. Os resultados se mantém? Use a <em>imagem1.pgm</em> como teste. </p>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Teste agora rodando com 3 threads. Os resultados se mantém? Eles são iguais ao item anterior?</p>
</div>
<h2 id="sincronizacao-com-regioes-criticas">Sincronização com regiões críticas<a class="headerlink" href="#sincronizacao-com-regioes-criticas" title="Permanent link">&para;</a></h2>
<p>Na expositiva vimos vários conceitos. Vamos agora ver sua execução no OpenMP. O snippet abaixo mostra como indicar um bloco de código como seção crítica. </p>
<div class="highlight"><pre><span></span><code><span class="cp">#pragma omp critical</span>
<span class="p">{</span>
    <span class="c1">// só uma thread entra por vez</span>
<span class="p">}</span>
</code></pre></div>
<p>Os principais usos são:</p>
<ol>
<li>trabalhar com arquivos e entrada/saída. Muito comum para acessar o terminal ou para arquivos de log;</li>
<li>usar classes ou estruturas de dados complexas. Acessos de escrita a vetores ou dicionários, por exemplo;</li>
<li>realizar operações lentas que não podem ser interrompidas.</li>
</ol>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Abra novamente o <code>exemplo1.cpp</code> da aula passada. Ao executá-lo é comum que os prints saiam embaralhados. Use <code>critical</code> para ter acesso exclusivo ao terminal e evitar isso. </p>
</div>
<p>Vamos agora aprender exatamente como usar variáveis compartilhadas e a diretiva <code>critical</code> para fazer o mesmo trabalho que a direriva <code>reduction</code>. Apesar de estarmos teoricamente reproduzindo um trabalho já bem implementado, temos duas vantagens pedagógicas:</p>
<ol>
<li>conseguimos conferir a qualidade de nossos resultados rapidamente</li>
<li>as técnicas usadas são aplicáveis também para paralelismo de tarefas</li>
<li><code>reduction</code> só funciona dentro de um <code>for</code> paralelo em que a variável for um tipo básico. Podemos precisar de reduções com mais de uma variável ou de um <code>struct</code>, por exemplo.</li>
</ol>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Para fazermos comparações e deixarmos nossos experimentos organizados, crie uma função <code>pi_sequencial(long num_steps)</code> que calcula o pi sequencialmente.</p>
</div>
<p>Nos próximos exercícios iremos criar versões paralelas do cálculo do <code>pi</code> explorando construções de sincronização do OpenMP para melhorar nosso desempenho.</p>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Um dos problemas de não usarmos a cláusula <code>reduction</code> é que acessos simultâneos a <code>sum</code> estragam seu valor (pois <code>+=</code> não é representado por apenas uma instrução em Assembly). Explique como <code>critical</code> pode ser usado para resolver este problema. </p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Crie uma função <code>pi_omp_critical1</code> que usa <code>critical</code> da maneira explicada acima para resolver os problemas de compartilhamento. Verifique que os resultados numéricos continuam iguais.</p>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Você consegue explicar o desempenho do programa acima? </p>
<details class="details"><summary>Resposta</summary><p>A utilização de <code>critical</code> é cara. Cada vez que uma thread chega na região crítica ela gasta tempo de processamento. Ou seja, entrar na região crítica muito frequentemente resulta em gastar tempo precioso em sincronização ao invés de gastar resolvendo nosso problema.</p>
</details>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Sincronização é caro e é um custo relevante de qualquer projeto de alto desempenho que não seja ingenuamente paralelizável. Nosso objetivo é sempre quere <strong>minimizar</strong> a sincronização feita pelas threads. </p>
</div>
<p>Tendo em vista o quadro acima, faça os próximos exercícios.</p>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Na parte 1 usamos a estratégia de criar uma cópia do gerador de números aleatórios para cada thread. Como poderiamos adaptar esta ideia para evitar o uso da região crítica?</p>
<details class="details"><summary>Resposta</summary><p>Basta novamente criar uma cópia para cada thread e acumular os resultados na cópia. Essa alocação deverá ser feita antes do início da região paralela. Ao finalizar podemos simplesmente somar as somas parciais e tudo estará OK. </p>
</details>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Implemente a ideia acima e chame sua função de <code>pi_omp_copias_parciais</code>. Verifique que os valores continuam iguais.</p>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Meça o tempo acima e verifique que houve ganho de desempenho em relação ao uso de <code>critical</code>. </p>
</div>
<p>A solução acima é funcional mas inconveniente: precisamos ficar alocando arrays a cada região paralela e depois ficar somando tudo no final. Podemos eliminar  esse vetor separando as diretivas <code>parallel</code> e <code>for</code> e tornar nosso código mais enxuto e legível. Veja abaixo um exemplo.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#pragma omp parallel</span>
<span class="p">{</span>
    <span class="kt">double</span> <span class="n">local</span><span class="p">;</span>
    <span class="cp">#pragma omp for</span>
    <span class="k">for</span> <span class="p">(...)</span> <span class="p">{</span>
        <span class="c1">// cada thread mexe na sua cópia de local</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Como você usaria a estrutura acima para chamar <code>critical</code> somente uma vez por thread? Explique por que sua solução funciona e por que ela deverá trazer grandes ganhos de desempenho.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Implemente sua função como <code>pi_omp_critical_local</code> e verifique que os resultados continuam corretos.</p>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Meça novamente o tempo de execução. Como essa função se compara com as outras implementações?</p>
</div>
<div class="admonition done">
<p class="admonition-title">Done</p>
<p>Finalizamos esta atividade com a seguinte conclusão: <strong>sincronização é cara, mas por vezes é o melhor que temos</strong>. Se precisamos fazer uma operação que torna um bloco de código uma <strong>região crítica</strong>, então não temos opção e tudo o que podemos é tornar essa região <strong>o menor possível</strong> e somente entrar nela <strong>quando for estritamente necessário</strong>.</p>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.6a3d08fc.min.js"></script>
      <script src="../../assets/javascripts/bundle.71201edf.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
      
        <script src="../../translate-admonitions.js"></script>
      
    
  </body>
</html>