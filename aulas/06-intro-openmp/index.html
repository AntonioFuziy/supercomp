



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://insper.github.io/supercomp/aulas/06-intro-openmp/">
      
      
        <meta name="author" content="Igor Montagner, Lucianos Soares">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>06 - Introdução a OpenMP - 7s - SuperComputação - Insper 2020/1</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#757575">
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../css/printing.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="grey" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#06-introducao-a-openmp" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <!--
  Copyright (c) 2016-2019 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->

<script>
    window.site_url = "https://insper.github.io/supercomp/";
</script>

<div class="md-printing-header">
  <img class="cabecalho" src="https://insper.github.io/supercomp/css/cabecalho.png">
  <img class="logo" src="https://insper.github.io/supercomp/css/logo.png">

  <div class="frontmatter">
    <div class="materia"> SuperComputação </div>
    <div class="professor"> Igor Montagner, Luciano Soares </div>
    <div class="semestre"> 2020/1 </div>
  </div>
</div>
<header class="md-header" data-md-component="header">



  <!-- Top-level navigation -->
  <nav class="md-header-nav md-grid">
    <div class="md-flex">

      <!-- Link to home -->
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://insper.github.io/supercomp/"
            title="7s - SuperComputação - Insper 2020/1"
            class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>      
      <!-- Button to toggle drawer -->
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button"
            for="__drawer"></label>
      </div>
      <!-- Header title -->
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title"
            data-md-component="title">
          
            <span class="md-header-nav__topic">
              7s - SuperComputação - Insper 2020/1
            </span>
            <span class="md-header-nav__topic">
              
                06 - Introdução a OpenMP
              
            </span>
          
        </div>
      </div>

      <!-- Button to open search dialogue -->
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button"
              for="__search"></label>

          <!-- Search interface -->
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>

      <!-- Repository containing source -->
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/insper/supercomp/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    SuperComp
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../00-organizacao/" class="md-tabs__link md-tabs__link--active">
          Aulas
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../projetos/" class="md-tabs__link">
          Projetos
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://insper.github.io/supercomp/" title="7s - SuperComputação - Insper 2020/1" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    7s - SuperComputação - Insper 2020/1
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/insper/supercomp/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    SuperComp
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../sobre/" title="Sobre" class="md-nav__link">
      Sobre
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Aulas
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Aulas
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../00-organizacao/" title="Organização do repositório" class="md-nav__link">
      Organização do repositório
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-cpp/" title="01 - Introdução a C++" class="md-nav__link">
      01 - Introdução a C++
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../02-stl/" title="02 - Templates e STL" class="md-nav__link">
      02 - Templates e STL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../03-cmake/" title="03 - CMake e Debugging no VSCode" class="md-nav__link">
      03 - CMake e Debugging no VSCode
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../04-autovec/" title="04 - SIMD: Autovetorização" class="md-nav__link">
      04 - SIMD: Autovetorização
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../05-intro-multi-core/" title="05 - Introdução a multi-core" class="md-nav__link">
      05 - Introdução a multi-core
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
    <a href="./" title="06 - Introdução a OpenMP" class="md-nav__link md-nav__link--active">
      06 - Introdução a OpenMP
    </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../07-openmp-for/" title="07 - OpenMP: Construções de alto nível" class="md-nav__link">
      07 - OpenMP: Construções de alto nível
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../08-efeitos-colaterais/" title="08 - Efeitos colaterais" class="md-nav__link">
      08 - Efeitos colaterais
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../09-tarefas/" title="09 - Tarefas" class="md-nav__link">
      09 - Tarefas
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Projetos
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Projetos
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/" title="Índice" class="md-nav__link">
      Índice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/checklist/" title="Requisitos básicos de projeto" class="md-nav__link">
      Requisitos básicos de projeto
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/projeto-pfe/" title="Projeto semestral - Alocação de alunos para o PFE" class="md-nav__link">
      Projeto semestral - Alocação de alunos para o PFE
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/projeto-multi-core/" title="Multi-core: C++ e OpenMP" class="md-nav__link">
      Multi-core: C++ e OpenMP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/insper/supercomp/edit/master/docs/aulas/06-intro-openmp.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="06-introducao-a-openmp">06 - Introdução a OpenMP<a class="headerlink" href="#06-introducao-a-openmp" title="Permanent link">&para;</a></h1>
<p>OpenMP é uma tecnologia de computação multi-core usada para paralelizar programas de modo facilitado. Ele é ideal para programar programas que usem o modelo <em>fork-join</em> que estudaremos nesta primeira parte do curso. </p>
<p><img alt="" src="../fork-join.png" />
Fonte: <a href="https://en.wikipedia.org/wiki/File:Fork_join.svg">https://en.wikipedia.org/wiki/File:Fork_join.svg</a></p>
<h1 id="parte-0-primeiros-usos">Parte 0 - primeiros usos<a class="headerlink" href="#parte-0-primeiros-usos" title="Permanent link">&para;</a></h1>
<p>Nesta parte do roteiro usaremos 4 chamadas do OpenMP para recriar o primeiro exemplo da aula passada. </p>
<ol>
<li><code>#pragma omp parallel</code> cria um conjunto de threads. Deve ser aplicado acima de um bloco de código limitado por <code>{  }</code></li>
<li><code>int omp_get_num_threads();</code> retorna o número de threads criadas (dentro de uma região paralela)</li>
<li><code>int omp_get_max_threads();</code> retorna o número de máximo de threads (fora de uma região paralela)</li>
<li><code>int omp_get_thread_num();</code> retorna o id da thread atual (entre 0 e o valor acima, dentro de uma região paralela)</li>
</ol>
<p>O código abaixo (<em>exemplo1.c</em>) ilustra como utilizar OpenMP para fazer o exercicio 1 do roteiro anterior (criar 4 threads e imprimir um id de 0 a 3).</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;omp.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="cp">#pragma omp parallel </span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ID:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">omp_get_thread_num</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/&quot;</span> <span class="o">&lt;&lt;</span> 
                           <span class="n">omp_get_num_threads</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Join implicito no fim do bloco!&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Perceba que a principal utilidade do OpenMP é facilitar a programação quando todas as threads rodam o mesmo programa e a criação de threads e a junção de seus resultados ocorre de maneira frequente no programa. </p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Compile o programa abaixo usando a seguinte linha de comando e rode-o.</p>
<blockquote>
<p><code>$ g++ -O3 exemplo1.cpp -o exemplo1 -fopenmp</code></p>
</blockquote>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>O OpenMP permite alterar o número máximo de threads criados usando a variável de ambiente <code>OMP_NUM_THREADS</code>. Rode <code>exemplo1</code> como abaixo.</p>
<blockquote>
<p><code>OMP_NUM_THREADS=2 ./exemplo1</code> </p>
</blockquote>
<p>Os resultados foram os esperados? Rode agora sem a variável de ambiente. Qual é o valor padrão assumido pelo OpenMP? É uma boa ideia usar mais threads que o valor padrão?</p>
</div>
<p>A utilização de <code>OMP_NUM_THREADS</code> ajuda a realizar testes de modo a compreender os ganhos de desempenho de um programa conforme mais threads são utilizadas. </p>
<h1 id="parte-1-funcionalidades-do-openmp">Parte 1 - funcionalidades do OpenMP<a class="headerlink" href="#parte-1-funcionalidades-do-openmp" title="Permanent link">&para;</a></h1>
<p>Vamos continuar usando o exemplo <em>pi-numeric-integration.cpp</em> neste roteiro. Iremos comparar nosso programa da aula passada com implementações usando OpenMP. </p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Refatore sua implementação da aula passada para que todo seu código usando threads esteja disponível em um função <code>double_pi_threads_raiz(long steps)</code> e que o código original esteja em uma função <code>double pi_seq(long steps)</code>.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Chame ambas funções no <code>main</code> e compare seus resultados e o tempo necessário para cada uma rodar. </p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Verifique que a versão usando threads demora um quarto do tempo da versão sequencial.</p>
</div>
<p>Vamos agora fazer um primeiro teste usando OpenMP. No exercício abaixo vamos somente substituir a criação das threads usando <code>&lt;threads&gt;</code> pela criação usando diretivas do OpenMP.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Crie uma função <code>double pi_omp_parallel(long steps)</code> que faça o cálculo do pi de modo paralelo usando <code>#pragma omp parallel</code>. Siga a mesma receita do seu programa usando threads:</p>
<ol>
<li>As iterações do <code>for</code> são divididas por igual entre as threads;</li>
<li>Cada thread acumula seus resultados parciais armazenados em um vetor <code>double sum[]</code>. Para efeitos de exercício, use a construção <code>sum[id] +=</code></li>
<li>No fim os resultados parciais são usados para o cálculo final.</li>
</ol>
<p>Adicione uma chamada a esta função no <code>main</code> e mostre seu resultado e o tempo gasto. </p>
</div>
<p>Já vimos que acessar a mesma variável (ou posição em um vetor) resulta em resultados incorretos. Por questões de cache, escrever em posições vizinhas de um vetor resulta em desempenho longe do ideal. Podemos arrumar isto criando uma variável local para acumular a soma e só escrever seu resultado no vetor <code>double sum[]</code> no fim.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Crie uma função <code>double pi_omp_parallel_local(long steps)</code> que, ao invés de fazer <code>sum[id] +=</code> use uma variável local para guardar a soma e faça a atribuição somente no fim da seção paralela. </p>
<p>Como antes, adicione uma chamada ao <code>main</code> e verifique se houve ganho de desempenho. </p>
</div>
<h2 id="sincronizacao">Sincronização<a class="headerlink" href="#sincronizacao" title="Permanent link">&para;</a></h2>
<p>O OpenMP nos permite eliminar o vetor <code>double sum[]</code> usando diretivas de sincronização de alto nível. As duas mais simples são <code>atomic</code> e <code>critical</code>.</p>
<p>A diretiva <code>atomic</code> executa uma atribuição ou uma operação aritmética <em>inplace</em> (<code>+=, -=, *=, /=</code>) garantindo que ela será concluída mesmo se outros cores tentarem fazê-la. </p>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Como você poderia eliminar o vetor <code>double sum[]</code> usado nos exercícios anteriores usando <code>atomic</code>?</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Faça uma função <code>double pi_omp_parallel_atomic(long steps)</code> usando esta diretiva, adicione-a no <code>main</code> e mostre seu resultado e o tempo gasto. Deverá haver ganho de desempenho.</p>
</div>
<p>A diretiva <code>critical</code> é aplicada a um bloco e faz com que ele esteja em execução em no máximo 1 das threads. Este nome vem do conceito de <em>seção crítica</em>, que representa uma seção de uma tarefa que não pode ser paralelizada de jeito algum e obrigatoriamente deve ser executada de modo sequencial. O uso de <code>critical</code> é muito perigoso, pois ao forçar a execução sequencial de um bloco de código podemos estar efetivamente matando o paralelismo do nosso programa. A construção <code>atomic</code> é uma seção crítica de apenas uma linha e usa suporte do hardware para rodar. A construção <code>critical</code> permite serializar várias linhas de código, mas exige suporte do Sistema Operacional e é bastante lenta. </p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Faça uma função <code>double pi_omp_parallel_critical(long steps)</code> usando esta diretiva, adicione-a no <code>main</code> e mostre seu resultado e o tempo gasto. A implementação correta deverá ficar praticamente igual ao <code>atomic</code>.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Vamos agora fazer uma implementação errada de <code>critical</code>. Na versão anterior usamos uma variável local para cada armazenar os resultados parciais de cada thread. Troque seu uso para  armazenar na variável de fora da seção paralela usando <code>critical</code>. Chame esta função de <code>double pi_omp_parallel_critical_errado(long steps)</code>. Adicione-a no <code>main</code> e mostre seu resultado e o tempo gasto. O resultado final deverá ser pior que suas outras versões. </p>
</div>
<p>Neste momento você deve ter obtido um programa com desempenho ao menos cerca de 50% mais rápido que o programa original. Mais importante, seu programa agora é muito mais simples de ler (e escrever) do que usando diretamente <code>std::thread</code>. Na próxima aula veremos como simplificar ainda mais estes códigos usando construções de alto nível do OpenMP.</p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../05-intro-multi-core/" title="05 - Introdução a multi-core" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                05 - Introdução a multi-core
              </span>
            </div>
          </a>
        
        
          <a href="../07-openmp-for/" title="07 - OpenMP: Construções de alto nível" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                07 - OpenMP: Construções de alto nível
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:"../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
      
        <script src="../../translate-admonitions.js"></script>
      
    
  </body>
</html>