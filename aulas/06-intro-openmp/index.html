


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="https://insper.github.io/supercomp/aulas/06-intro-openmp/">
      
      
        <meta name="author" content="Igor Montagner, Lucianos Soares">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.1">
    
    
      
        <title>06 - Introdução a OpenMP - 7s - SuperComputação - Insper 2020/1</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a676eddb.min.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/palette.b302131d.min.css">
      
      
        
        
        <meta name="theme-color" content="#757575">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/printing.css">
    
    
      
    
    
  </head>
  
  
    
    
    <body dir="ltr" data-md-color-primary="grey" data-md-color-accent="red">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#06-introducao-a-openmp" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      











<!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->

<script>
  window.site_url = "https://insper.github.io/supercomp/";
</script>

<div class="md-printing-header">
  <img class="cabecalho" src="https://insper.github.io/supercomp/css/cabecalho.png">
  <img class="logo" src="https://insper.github.io/supercomp/css/logo.png">

  <div class="frontmatter">
    <div class="materia"> SuperComputação </div>
    <div class="professor"> Igor Montagner, Luciano Soares </div>
    <div class="semestre"> 2020/1 </div>
  </div>
</div>

<header class="md-header" data-md-component="header">

  <!-- Top-level navigation -->
  <nav class="md-header-nav md-grid" aria-label="Header">

    <!-- Link to home -->
    <a
      href="https://insper.github.io/supercomp/"
      title="7s - SuperComputação - Insper 2020/1"
      class="md-header-nav__button md-logo"
      aria-label="7s - SuperComputação - Insper 2020/1"
    >
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>

    <!-- Button to open drawer -->
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </label>

    <!-- Header title -->
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            7s - SuperComputação - Insper 2020/1
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              06 - Introdução a OpenMP
            
          </span>
        </div>
      
    </div>

    <!-- Button to open search dialogue -->
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
      </label>

      <!-- Search interface -->
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    

    <!-- Repository containing source -->
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/insper/supercomp/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    SuperComp
  </div>
</a>
      </div>
    
  </nav>
</header>




    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://insper.github.io/supercomp/" title="7s - SuperComputação - Insper 2020/1" class="md-nav__button md-logo" aria-label="7s - SuperComputação - Insper 2020/1">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    7s - SuperComputação - Insper 2020/1
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/insper/supercomp/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    SuperComp
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../sobre/" title="Sobre" class="md-nav__link">
      Sobre
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Aulas
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Aulas" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Aulas
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../00-organizacao/" title="Organização do repositório" class="md-nav__link">
      Organização do repositório
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-cpp/" title="01 - Introdução a C++" class="md-nav__link">
      01 - Introdução a C++
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../02-stl/" title="02 - Templates e STL" class="md-nav__link">
      02 - Templates e STL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../03-cmake/" title="03 - CMake e Debugging no VSCode" class="md-nav__link">
      03 - CMake e Debugging no VSCode
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../04-autovec/" title="04 - SIMD: Autovetorização" class="md-nav__link">
      04 - SIMD: Autovetorização
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../05-intro-multi-core/" title="05 - Introdução a multi-core" class="md-nav__link">
      05 - Introdução a multi-core
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
    <a href="./" title="06 - Introdução a OpenMP" class="md-nav__link md-nav__link--active">
      06 - Introdução a OpenMP
    </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../07-openmp-for/" title="07 - OpenMP: Construções de alto nível" class="md-nav__link">
      07 - OpenMP: Construções de alto nível
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../08-efeitos-colaterais/" title="08 - Efeitos colaterais" class="md-nav__link">
      08 - Efeitos colaterais
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../09-tarefas/" title="09 - Tarefas" class="md-nav__link">
      09 - Tarefas
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../10-gpu-I/" title="10 - introdução a GPU" class="md-nav__link">
      10 - introdução a GPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../11-gpu-II/" title="11 - introdução a GPU - II" class="md-nav__link">
      11 - introdução a GPU - II
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../12-gpu-III/" title="12 - introdução a GPU - III" class="md-nav__link">
      12 - introdução a GPU - III
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../13-gpu-rand/" title="13 - Números aleatórios em GPU" class="md-nav__link">
      13 - Números aleatórios em GPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../14-gpu-rand-II/" title="14 - Mais números aleatórios em" class="md-nav__link">
      14 - Mais números aleatórios em
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Projetos
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Projetos" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Projetos
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/" title="Índice" class="md-nav__link">
      Índice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/projeto-pfe/" title="Alocação de alunos para o PFE" class="md-nav__link">
      Alocação de alunos para o PFE
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/checklist/" title="Requisitos básicos de projeto" class="md-nav__link">
      Requisitos básicos de projeto
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/insper/supercomp/edit/master/docs/aulas/06-intro-openmp.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>
                  </a>
                
                
                  
                
                
                <h1 id="06-introducao-a-openmp">06 - Introdução a OpenMP<a class="headerlink" href="#06-introducao-a-openmp" title="Permanent link">&para;</a></h1>
<p>OpenMP é uma tecnologia de computação multi-core usada para paralelizar programas de modo facilitado. Ele é ideal para programar programas que usem o modelo <em>fork-join</em> que estudaremos nesta primeira parte do curso. </p>
<p><img alt="" src="../fork-join.png" />
Fonte: <a href="https://en.wikipedia.org/wiki/File:Fork_join.svg">https://en.wikipedia.org/wiki/File:Fork_join.svg</a></p>
<h1 id="parte-0-primeiros-usos">Parte 0 - primeiros usos<a class="headerlink" href="#parte-0-primeiros-usos" title="Permanent link">&para;</a></h1>
<p>Nesta parte do roteiro usaremos 4 chamadas do OpenMP para recriar o primeiro exemplo da aula passada. </p>
<ol>
<li><code>#pragma omp parallel</code> cria um conjunto de threads. Deve ser aplicado acima de um bloco de código limitado por <code>{  }</code></li>
<li><code>int omp_get_num_threads();</code> retorna o número de threads criadas (dentro de uma região paralela)</li>
<li><code>int omp_get_max_threads();</code> retorna o número de máximo de threads (fora de uma região paralela)</li>
<li><code>int omp_get_thread_num();</code> retorna o id da thread atual (entre 0 e o valor acima, dentro de uma região paralela)</li>
</ol>
<p>O código abaixo (<em>exemplo1.c</em>) ilustra como utilizar OpenMP para fazer o exercicio 1 do roteiro anterior (criar 4 threads e imprimir um id de 0 a 3).</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;omp.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="cp">#pragma omp parallel </span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ID:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">omp_get_thread_num</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/&quot;</span> <span class="o">&lt;&lt;</span> 
                           <span class="n">omp_get_num_threads</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Join implicito no fim do bloco!&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Perceba que a principal utilidade do OpenMP é facilitar a programação quando todas as threads rodam o mesmo programa e a criação de threads e a junção de seus resultados ocorre de maneira frequente no programa. </p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Compile o programa abaixo usando a seguinte linha de comando e rode-o.</p>
<blockquote>
<p><code>$ g++ -O3 exemplo1.cpp -o exemplo1 -fopenmp</code></p>
</blockquote>
</div>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>O OpenMP permite alterar o número máximo de threads criados usando a variável de ambiente <code>OMP_NUM_THREADS</code>. Rode <code>exemplo1</code> como abaixo.</p>
<blockquote>
<p><code>OMP_NUM_THREADS=2 ./exemplo1</code> </p>
</blockquote>
<p>Os resultados foram os esperados? Rode agora sem a variável de ambiente. Qual é o valor padrão assumido pelo OpenMP? É uma boa ideia usar mais threads que o valor padrão?</p>
</div>
<p>A utilização de <code>OMP_NUM_THREADS</code> ajuda a realizar testes de modo a compreender os ganhos de desempenho de um programa conforme mais threads são utilizadas. </p>
<h1 id="parte-1-funcionalidades-do-openmp">Parte 1 - funcionalidades do OpenMP<a class="headerlink" href="#parte-1-funcionalidades-do-openmp" title="Permanent link">&para;</a></h1>
<p>Vamos continuar usando o exemplo <em>pi-numeric-integration.cpp</em> neste roteiro. Iremos comparar nosso programa da aula passada com implementações usando OpenMP. </p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Refatore sua implementação da aula passada para que todo seu código usando threads esteja disponível em um função <code>double_pi_threads_raiz(long steps)</code> e que o código original esteja em uma função <code>double pi_seq(long steps)</code>.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Chame ambas funções no <code>main</code> e compare seus resultados e o tempo necessário para cada uma rodar. </p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Verifique que a versão usando threads demora um quarto do tempo da versão sequencial.</p>
</div>
<p>Vamos agora fazer um primeiro teste usando OpenMP. No exercício abaixo vamos somente substituir a criação das threads usando <code>&lt;threads&gt;</code> pela criação usando diretivas do OpenMP.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Crie uma função <code>double pi_omp_parallel(long steps)</code> que faça o cálculo do pi de modo paralelo usando <code>#pragma omp parallel</code>. Siga a mesma receita do seu programa usando threads:</p>
<ol>
<li>As iterações do <code>for</code> são divididas por igual entre as threads;</li>
<li>Cada thread acumula seus resultados parciais armazenados em um vetor <code>double sum[]</code>. Para efeitos de exercício, use a construção <code>sum[id] +=</code></li>
<li>No fim os resultados parciais são usados para o cálculo final.</li>
</ol>
<p>Adicione uma chamada a esta função no <code>main</code> e mostre seu resultado e o tempo gasto. </p>
</div>
<p>Já vimos que acessar a mesma variável (ou posição em um vetor) resulta em resultados incorretos. Por questões de cache, escrever em posições vizinhas de um vetor resulta em desempenho longe do ideal. Podemos arrumar isto criando uma variável local para acumular a soma e só escrever seu resultado no vetor <code>double sum[]</code> no fim.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Crie uma função <code>double pi_omp_parallel_local(long steps)</code> que, ao invés de fazer <code>sum[id] +=</code> use uma variável local para guardar a soma e faça a atribuição somente no fim da seção paralela. </p>
<p>Como antes, adicione uma chamada ao <code>main</code> e verifique se houve ganho de desempenho. </p>
</div>
<h2 id="sincronizacao">Sincronização<a class="headerlink" href="#sincronizacao" title="Permanent link">&para;</a></h2>
<p>O OpenMP nos permite eliminar o vetor <code>double sum[]</code> usando diretivas de sincronização de alto nível. As duas mais simples são <code>atomic</code> e <code>critical</code>.</p>
<p>A diretiva <code>atomic</code> executa uma atribuição ou uma operação aritmética <em>inplace</em> (<code>+=, -=, *=, /=</code>) garantindo que ela será concluída mesmo se outros cores tentarem fazê-la. </p>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Como você poderia eliminar o vetor <code>double sum[]</code> usado nos exercícios anteriores usando <code>atomic</code>?</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Faça uma função <code>double pi_omp_parallel_atomic(long steps)</code> usando esta diretiva, adicione-a no <code>main</code> e mostre seu resultado e o tempo gasto. Deverá haver ganho de desempenho.</p>
</div>
<p>A diretiva <code>critical</code> é aplicada a um bloco e faz com que ele esteja em execução em no máximo 1 das threads. Este nome vem do conceito de <em>seção crítica</em>, que representa uma seção de uma tarefa que não pode ser paralelizada de jeito algum e obrigatoriamente deve ser executada de modo sequencial. O uso de <code>critical</code> é muito perigoso, pois ao forçar a execução sequencial de um bloco de código podemos estar efetivamente matando o paralelismo do nosso programa. A construção <code>atomic</code> é uma seção crítica de apenas uma linha e usa suporte do hardware para rodar. A construção <code>critical</code> permite serializar várias linhas de código, mas exige suporte do Sistema Operacional e é bastante lenta. </p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Faça uma função <code>double pi_omp_parallel_critical(long steps)</code> usando esta diretiva, adicione-a no <code>main</code> e mostre seu resultado e o tempo gasto. A implementação correta deverá ficar praticamente igual ao <code>atomic</code>.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Vamos agora fazer uma implementação errada de <code>critical</code>. Na versão anterior usamos uma variável local para cada armazenar os resultados parciais de cada thread. Troque seu uso para  armazenar na variável de fora da seção paralela usando <code>critical</code>. Chame esta função de <code>double pi_omp_parallel_critical_errado(long steps)</code>. Adicione-a no <code>main</code> e mostre seu resultado e o tempo gasto. O resultado final deverá ser pior que suas outras versões. </p>
</div>
<p>Neste momento você deve ter obtido um programa com desempenho ao menos cerca de 50% mais rápido que o programa original. Mais importante, seu programa agora é muito mais simples de ler (e escrever) do que usando diretamente <code>std::thread</code>. Na próxima aula veremos como simplificar ainda mais estes códigos usando construções de alto nível do OpenMP.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../05-intro-multi-core/" title="05 - Introdução a multi-core" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                05 - Introdução a multi-core
              </div>
            </div>
          </a>
        
        
          <a href="../07-openmp-for/" title="07 - OpenMP: Construções de alto nível" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                07 - OpenMP: Construções de alto nível
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z" /></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.c51dfa35.min.js"></script>
      <script src="../../assets/javascripts/bundle.eaaa3931.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.58d22e8e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
      
        <script src="../../translate-admonitions.js"></script>
      
    
  </body>
</html>