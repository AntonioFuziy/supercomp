


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="https://insper.github.io/supercomp/aulas/18-transformacoes-customizadas/">
      
      
        <meta name="author" content="Igor Montagner, Lucianos Soares">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.6">
    
    
      
        <title>19 - Operações customizadas - SuperComputação - 2020/2</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.63b94e9e.min.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/palette.7f672a1f.min.css">
      
      
        
        
        <meta name="theme-color" content="#757575">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/printing.css">
    
      <link rel="stylesheet" href="../../css/extra.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="grey" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#19-operacoes-customizadas" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      











<!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->

<script>
  window.site_url = "https://insper.github.io/supercomp/";
</script>

<div class="md-printing-header">
  <img class="cabecalho" src="https://insper.github.io/supercomp/css/cabecalho.png">
  <img class="logo" src="https://insper.github.io/supercomp/css/logo.png">

  <div class="frontmatter">
    <div class="materia"> SuperComputação </div>
    <div class="professor"> Igor Montagner, Luciano Soares </div>
    <div class="semestre"> 2020/2 </div>
  </div>
</div>

<header class="md-header" data-md-component="header">

  <!-- Top-level navigation -->
  <nav class="md-header-nav md-grid" aria-label="Header">

    <!-- Link to home -->
    <a
      href="https://insper.github.io/supercomp/"
      title="SuperComputação - 2020/2"
      class="md-header-nav__button md-logo"
      aria-label="SuperComputação - 2020/2"
    >
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>

    <!-- Button to open drawer -->
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>

    <!-- Header title -->
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            SuperComputação - 2020/2
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              19 - Operações customizadas
            
          </span>
        </div>
      
    </div>

    <!-- Button to open search dialogue -->
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>

      <!-- Search interface -->
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    

    <!-- Repository containing source -->
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/insper/supercomp/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    SuperComp
  </div>
</a>
      </div>
    
  </nav>
</header>




    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://insper.github.io/supercomp/" title="SuperComputação - 2020/2" class="md-nav__button md-logo" aria-label="SuperComputação - 2020/2">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    SuperComputação - 2020/2
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/insper/supercomp/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    SuperComp
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../sobre/" title="Burocracias" class="md-nav__link">
      Burocracias
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Aulas
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Aulas" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Aulas
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../01-introducao/" title="01 - Aquecimento" class="md-nav__link">
      01 - Aquecimento
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../02-desempenho/" title="02 - Iniciando C++11" class="md-nav__link">
      02 - Iniciando C++11
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../03-profiling-e-projeto/" title="03 - Profiling" class="md-nav__link">
      03 - Profiling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../04-projeto-heuristicas/" title="04 - Heurísticas" class="md-nav__link">
      04 - Heurísticas
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../05-algoritmos-aleatorios/" title="05 - Algoritmos Aleatorizados" class="md-nav__link">
      05 - Algoritmos Aleatorizados
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../06-busca-local/" title="06 - Busca local" class="md-nav__link">
      06 - Busca local
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../07-busca-exaustiva/" title="07 - Busca exaustiva" class="md-nav__link">
      07 - Busca exaustiva
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../08-busca-exaustiva-II/" title="08 - Comparação de resultados" class="md-nav__link">
      08 - Comparação de resultados
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../09-branch-and-bound/" title="09 - Branch and Bound" class="md-nav__link">
      09 - Branch and Bound
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../10-branch-and-bound-II/" title="10 - Branch and Bound II" class="md-nav__link">
      10 - Branch and Bound II
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../11-introducao-paralelismo/" title="11 - Introdução a paralelismo" class="md-nav__link">
      11 - Introdução a paralelismo
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../12-introducao-omp/" title="12 - Introdução a OpenMP" class="md-nav__link">
      12 - Introdução a OpenMP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../13-paralelismo-dados/" title="13 - Paralelismo de dados" class="md-nav__link">
      13 - Paralelismo de dados
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../14-efeitos-colaterais/" title="14 - Efeitos colaterais" class="md-nav__link">
      14 - Efeitos colaterais
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../15-exercicio/" title="15 - Exercício prático" class="md-nav__link">
      15 - Exercício prático
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../16-intro-gpu/" title="16/17 - Introdução a GPU" class="md-nav__link">
      16/17 - Introdução a GPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../17-gpu-iteradores/" title="18 - Iteradores em Thrust" class="md-nav__link">
      18 - Iteradores em Thrust
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        19 - Operações customizadas
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="19 - Operações customizadas" class="md-nav__link md-nav__link--active">
      19 - Operações customizadas
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#estruturas-2d-matrizes-e-imagens" class="md-nav__link">
    Estruturas 2D - matrizes e imagens
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../19-gpu-random/" title="20 - GPU e números aleatórios" class="md-nav__link">
      20 - GPU e números aleatórios
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Projeto
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Projeto" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Projeto
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/" title="Travelling Sales Person (TSP)" class="md-nav__link">
      Travelling Sales Person (TSP)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/checklist/" title="Checklist de projeto" class="md-nav__link">
      Checklist de projeto
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/heuristica/" title="Heurística da cidade mais próxima" class="md-nav__link">
      Heurística da cidade mais próxima
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/busca-local/" title="Busca local" class="md-nav__link">
      Busca local
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/busca-exaustiva/" title="Busca exaustiva" class="md-nav__link">
      Busca exaustiva
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/desempenho-sequencial/" title="Desempenho sequencial" class="md-nav__link">
      Desempenho sequencial
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../projetos/multi-core/" title="Paralelismo multi-core" class="md-nav__link">
      Paralelismo multi-core
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#estruturas-2d-matrizes-e-imagens" class="md-nav__link">
    Estruturas 2D - matrizes e imagens
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/insper/supercomp/edit/master/docs/aulas/18-transformacoes-customizadas/index.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="19-operacoes-customizadas">19 - Operações customizadas<a class="headerlink" href="#19-operacoes-customizadas" title="Permanent link">&para;</a></h1>
<p>Vamos trabalhar hoje com transformações customizadas. O último argumento de <code>thrust::transform</code> é a operação a ser realizada. Já usamos funções prontas com <code>thrust::plus&lt;double&gt;()</code> e <code>thrust::multiply&lt;double&gt;()</code>.  </p>
<p>Para criar nossas próprias operações usamos a seguinte sintaxe:</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="n">custom_transform</span>
<span class="p">{</span>
    <span class="c1">// essas marcações indicam que o código deve ser compilado para CPU (host) </span>
    <span class="c1">// e GPU (device)</span>
    <span class="c1">// IMPORTANTE: somente código com a marcação __device__ é compilado para GPU</span>
    <span class="n">__host__</span> <span class="n">__device__</span>
        <span class="kt">double</span> <span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="kt">double</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="kt">double</span><span class="o">&amp;</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// isto pode ser usado com um transform que usa dois vetores </span>
            <span class="c1">// e coloca o resultado em um terceiro.</span>

            <span class="c1">// x é um elemento do primeiro vetor</span>
            <span class="c1">// y é o elemento correspondente do segundo vetor</span>

            <span class="c1">// o valor retornado é colocado no vetor de resultados</span>

            <span class="c1">// para fazer operações unárias basta receber somente um argumento.</span>
        <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>A operação acima seria aceita em um transform como o abaixo:</p>
<div class="highlight"><pre><span></span><code><span class="n">thrust</span><span class="o">::</span><span class="n">device_vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">;</span>
<span class="n">thrust</span><span class="o">::</span><span class="n">transform</span><span class="p">(</span><span class="n">A</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">A</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">B</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">C</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">custom_transform</span><span class="p">());</span>
</code></pre></div>
<p>Note que os tipos dos vetores devem bater com os tipos declarados no <code>struct</code>. Por vezes precisamos receber parâmetros para a operação customizada funcionar. Um truque comum é adicionar atributos no <code>struct</code> usado como operação:</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="n">T</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">attr</span><span class="p">;</span>

    <span class="n">T</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">)</span><span class="o">:</span> <span class="n">attr</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">{};</span>

    <span class="c1">// TODO: operação customizada aqui</span>
<span class="p">};</span>
</code></pre></div>
<p>O valor <code>attr</code> estará disponível para uso dentro da operação customizada. A linha <code>T(int a): attr(a) {}</code> declara o construtor do <code>struct T</code>. Ela faz com que o atributo <code>attr</code> seja inicializado com o valor do parâmetro <code>a</code>. Se houver mais de uma atribuição parâmetro - atributo é só usar <code>,</code> para separar as inicializações. Note que só podemos receber tipos básicos, então não daria para passar um <code>std::vector</code> como argumento.</p>
<p>Vamos agora usar esta nova sintaxe para escrever código mais sucinto (e complexo) em <code>thrust</code>. </p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Faça uma nova implementação da variância, dessa vez usando uma operação customizada e com a chamada <code>transform_reduce</code>. </p>
<p><strong>Dica</strong>: passe a média do vetor como parâmetro para seu <code>struct</code>.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Chamadas a GPU tem um custo fixo. Ao usar <code>transform_reduce</code> evitamos incorrer esse custo duas vezes. Também economizamos um vetor temporário que seria usado para guardar os elementos do somatório antes da operação <code>reduce</code>.</p>
</div>
<h2 id="estruturas-2d-matrizes-e-imagens">Estruturas 2D - matrizes e imagens<a class="headerlink" href="#estruturas-2d-matrizes-e-imagens" title="Permanent link">&para;</a></h2>
<p>Assim como na CPU, podemos representar imagens como um vetor "deitado". O acesso ao elemento <code>(i, j)</code> é feito como abaixo.</p>
<div class="highlight"><pre><span></span><code><span class="n">img</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div>
<p>Logo, podemos guardar matrizes na GPU apesar de só temos vetores 1D: basta sempre fazer a conta acima para descobrir o elemento 1D a partir das coordenadas <code>(x,y)</code>.</p>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Como descobrir as coordenadas <code>(x,y)</code> a partir do índice 1D?</p>
<details class="details"><summary>Resposta</summary><p>Sendo <code>k</code> o índice 1D:
<div class="highlight"><pre><span></span><code>y = k / largura
x = k % largura
</code></pre></div></p>
</details>
</div>
<p>Vamos começar com um processamento de imagens bem simples: o limiar.</p>
<ol>
<li>Se o ponto atual for maior que <code>127</code>, coloque na saída <code>255</code> (branco)</li>
<li>caso contrário, coloque na saída <code>0</code> (preto)</li>
</ol>
<div class="admonition question short">
<p class="admonition-title">Question</p>
<p>Retome os arquivos <code>imagem.h/cpp</code> da <a href="https://insper.github.io/supercomp/aulas/13-paralelismo-dados/#exercicio-pratico">aula 13</a>. Quais dados você precisaria copiar para a GPU? Quais dados seriam copiados de volta para a CPU ao finalizar?</p>
<details class="details"><summary>Resposta</summary><p>É necessário copiar o vetor pixels e o tamanho total da imagem para a GPU, o que significa que teremos um vetor para a imagem de entrada. O vetor de saída também deve ser criado na GPU, mas não precisa ser inicializado. Após o cálculo ele deverá ser copiado de volta para a CPU.</p>
</details>
</div>
<p>Podemos copiar dados de ponteiros "crus" para a GPU com uma sintaxe parecida com os nossos <code>host_vector</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="o">*</span><span class="n">dados</span><span class="p">;</span> <span class="c1">// possui N elementos</span>
<span class="n">thrust</span><span class="o">::</span><span class="n">device_vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">dados_gpu</span><span class="p">(</span><span class="n">dados</span><span class="p">,</span> <span class="n">dados</span> <span class="o">+</span> <span class="n">N</span><span class="p">);</span>
</code></pre></div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Use uma transformação customizada para implementar o filtro do limiar. Use os arquivos examinados na pergunta anterior. </p>
</div>
<p>A operação acima encaixa bem na <code>thrust</code> pois é ponto a ponto: cada processamento só leva em conta o valor do ponto atual. A maioria dos filtros, porém, usa informações da vizinhança de um ponto. Um exemplo é o <em>filtro de média</em> mostrado abaixo.</p>
<p>Dada uma imagem de entrada <span><span class="MathJax_Preview">I</span><script type="math/tex">I</script></span>, a imagem de saída <span><span class="MathJax_Preview">O</span><script type="math/tex">O</script></span> é dada pela seguinte expressão.</p>
<div>
<div class="MathJax_Preview">
O[i, j] = \frac{I[i, j] + I[i-1, j] + I[i+1, j] + I[i, j-1] + I[i,j+1]}{5}
</div>
<script type="math/tex; mode=display">
O[i, j] = \frac{I[i, j] + I[i-1, j] + I[i+1, j] + I[i, j-1] + I[i,j+1]}{5}
</script>
</div>
<p>Ambas as imagens tem o mesmo tamanho. Se o pixel acessado estiver fora da área válida da imagem ele deve ser considerado 0. </p>
<p>Apesar da <code>thrust</code> nos permitir acessar os dados de cada iteração, o acesso a elementos arbitrários do vetor não é diretamente suportado. Apesar de ser possível fazer isto com iteradores e tuplas, vamos usar uma abordagem um pouco diferente: acessar o vetor diretamente e usar a <code>thrust</code> para fornecer ao nossa transformação customizada o índice a ser usado. Vejamos abaixo um exemplo (arquivo <em>raw_access.cu</em>):</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="n">raw_access</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

    <span class="n">raw_access</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="o">:</span> <span class="n">ptr</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{};</span>

    <span class="n">__device__</span> <span class="n">__host__</span>
    <span class="kt">double</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">const</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="p">...</span>
<span class="n">thrust</span><span class="o">::</span><span class="n">counting_iterator</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">iter</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">raw_access</span> <span class="nf">ra</span><span class="p">(</span><span class="n">thrust</span><span class="o">::</span><span class="n">raw_pointer_cast</span><span class="p">(</span><span class="n">vec</span><span class="p">.</span><span class="n">data</span><span class="p">()));</span>
<span class="n">thrust</span><span class="o">::</span><span class="n">transform</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">iter</span><span class="o">+</span><span class="n">vec</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">vec</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">ra</span><span class="p">);</span>
<span class="p">...</span>
</code></pre></div>
<p>No código acima nossa operação customizada recebe o vetor como parâmetro de criação do <code>struct</code>. O valor passado pelo <code>transform</code> agora é o <strong>índice a ser preenchido no vetor de saída</strong>. Para simplificar, em geral vamos entender que o vetor de entrada e o de saída são do mesmo tamanho. Ou seja, conseguimos escrever código em GPU trabalhando somente com ponteiros e índices. Código arbitrariamente complexo pode estar dentro do <code>operator()</code>, desde que seja retornado o valor a ser colocado no vetor de saída na posição <code>i</code>.</p>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>No caso acima o vetor de entrada e saída eram o mesmo. Não há problema pois a operação só acessa o elemento <code>i</code>. Porém, se acessasse outros não conseguimos garantir a ordem das operações e os resultados seriam imprevisíveis. Na dúvida, sempre envie os dados para um vetor de saída diferente.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Implemente um programa <code>media_gpu</code> que faz o processamento descrito acima usando <code>thrust</code>. Seu programa deverá funcionar como abaixo. </p>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../17-gpu-iteradores/" title="18 - Iteradores em Thrust" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                18 - Iteradores em Thrust
              </div>
            </div>
          </a>
        
        
          <a href="../19-gpu-random/" title="20 - GPU e números aleatórios" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                20 - GPU e números aleatórios
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
      
        <script src="../../translate-admonitions.js"></script>
      
    
  </body>
</html>